# Data Model: ChatKit Frontend Integration

**Feature**: 006-chatkit-frontend-integration
**Date**: 2025-12-13

## Overview

This feature introduces minimal data structures for bridging chat messages between frontend and backend. Most data handling is managed by ChatKit libraries; this document captures the integration layer only.

## Entities

### Chat Message (Frontend State)

**Description**: Represents a single message in the conversation UI

**Fields**:
- `id`: string - Unique identifier for the message (generated by ChatKit)
- `role`: "user" | "assistant" - Sender of the message
- `content`: string - Message text
- `timestamp`: Date - When the message was created
- `status`: "sending" | "sent" | "streaming" | "complete" | "error" - Message state

**Lifecycle**:
1. User types message → status: "sending"
2. Backend receives → status: "sent"
3. Response starts → status: "streaming"
4. Response complete → status: "complete"
5. Error occurs → status: "error"

**Validation**:
- content: min length 1 character, max length 10,000 characters
- role: must be either "user" or "assistant"

**Relationships**:
- Belongs to a Chat Session

---

### Chat Session (Frontend State)

**Description**: Represents a single conversation thread within a browser session

**Fields**:
- `id`: string - Session identifier (generated by ChatKit)
- `messages`: Array<Chat Message> - Ordered list of messages
- `created_at`: Date - Session start time
- `last_activity`: Date - Last message timestamp

**Lifecycle**:
1. User clicks chatbot icon → Session created
2. User sends messages → Messages appended
3. User closes chat panel → Session persists in memory
4. User refreshes page → Session destroyed (no persistence)

**Validation**:
- messages: max 100 messages per session (prevent memory issues)
- Session expires after 30 minutes of inactivity (frontend cleanup)

**Relationships**:
- Has many Chat Messages

---

### Book Content Chunk (Existing - No Modification)

**Description**: Pre-indexed book content stored in Qdrant vector database

**Fields** (read-only reference):
- `id`: string - Chunk identifier
- `content`: string - Text content from book
- `metadata`: object - Chapter, section, page number
- `embedding`: vector - Semantic embedding

**Note**: This entity exists in the RAG backend and is **NOT modified** by this feature. The ChatKit server queries it via the existing agent.

---

### Thread (ChatKit Protocol)

**Description**: Server-side representation of a conversation thread (managed by ChatKit-Python)

**Fields** (ChatKit-provided structure):
- `id`: string - Thread identifier
- `metadata`: object - Custom thread metadata
- `messages`: Array - Message history

**Note**: This is a ChatKit library construct, not a custom data model. Documented for completeness.

---

### User Message (ChatKit Protocol)

**Description**: Incoming message from frontend (managed by ChatKit-Python)

**Fields** (ChatKit-provided structure):
- `id`: string - Message identifier
- `content`: string - Message text
- `timestamp`: datetime - Message creation time

**Note**: This is a ChatKit library construct, not a custom data model. Documented for completeness.

---

## State Management

### Frontend State (React Component)

**Location**: `src/components/Chatbot/index.jsx`

**State Structure**:
```typescript
// Managed by ChatKit-JS useChatKit hook
interface ChatKitState {
  control: ChatKitControl;     // ChatKit control object
  isOpen: boolean;             // Panel open/closed
  messages: ChatMessage[];     // Current conversation
  isStreaming: boolean;        // Response streaming status
  error: Error | null;         // Error state
}
```

**Persistence**: None - state exists only in memory for current browser session

---

### Backend State (ChatKit Server)

**Location**: `backend/chatkit_server.py`

**State Structure**:
```python
# No persistent state required
# Each request is stateless:
# 1. Receive message
# 2. Call agent
# 3. Stream response
# 4. Complete
```

**Note**: The backend is stateless. Thread/message state is managed by ChatKit-Python library internally. The RAG agent has its own state (Qdrant database) which is **not modified**.

---

## Data Flow

### User Message Flow

1. **Frontend Capture**: User types message in ChatKit UI
2. **Frontend Validation**: ChatKit-JS validates non-empty message
3. **Frontend Send**: ChatKit-JS sends message to `/chatkit` endpoint
4. **Backend Receive**: ChatKitServer.respond() receives UserMessage
5. **Agent Processing**: Extract `message.content`, call existing RAG agent
6. **Backend Stream**: Convert agent response to TextDelta events
7. **Frontend Display**: ChatKit-JS displays streaming text in UI

### Session Lifecycle

1. **Session Start**: User clicks chatbot icon → ChatKit-JS initializes
2. **Conversation**: Messages exchanged, stored in frontend state
3. **Session Pause**: User closes panel → state persists in memory
4. **Session Resume**: User reopens panel → previous messages visible
5. **Session End**: User closes tab or refreshes → state lost

---

## Validation Rules

### Input Validation (Frontend)

- **Empty Messages**: Blocked by ChatKit-JS (submit button disabled)
- **Max Length**: 10,000 characters (prevent abuse)
- **Special Characters**: All UTF-8 allowed (multilingual support)

### Input Validation (Backend)

- **Message Content**: Strip leading/trailing whitespace
- **Length Check**: Reject messages > 10,000 characters (security)
- **Encoding**: Ensure UTF-8 encoding

### Response Validation

- **Streaming Timeout**: 30 seconds max per response chunk
- **Total Response**: No hard limit (streaming handles long responses)
- **Error Messages**: Max 500 characters for user-facing errors

---

## Error States

### Frontend Error Handling

| Error Type | User Message | Recovery |
|------------|-------------|----------|
| Connection Failed | "Cannot connect to chat server. Please try again." | Retry button |
| Timeout | "Request timed out. Please try again." | Retry button |
| Server Error | "Something went wrong. Please try again later." | Refresh or retry |
| Empty Response | "No response received. Please try again." | Retry button |

### Backend Error Handling

| Error Type | Log Level | Response to Frontend |
|------------|-----------|---------------------|
| Agent Failure | ERROR | Yield error event with friendly message |
| Qdrant Timeout | WARNING | "Search is taking longer than expected" |
| Invalid Input | INFO | Validation error message |
| Unexpected Exception | ERROR | "An error occurred processing your request" |

---

## Performance Considerations

### Memory Management

- **Frontend**: Limit to 100 messages per session (auto-trim oldest)
- **Backend**: No state stored (stateless request handling)
- **Streaming**: Use generators to avoid loading full responses in memory

### Caching

- **No Caching**: Each question queries RAG agent fresh (ensures up-to-date answers)
- **Exception**: Browser may cache static assets (JS/CSS) per standard caching

---

## Security Considerations

### Input Sanitization

- **XSS Prevention**: ChatKit-JS escapes all user content by default
- **Injection Prevention**: Backend treats all input as plain text (no code execution)
- **Length Limits**: Enforce max message length to prevent DoS

### Data Privacy

- **No Persistence**: Messages not stored server-side
- **No Logging**: User messages not logged to files (optional: log anonymized metrics)
- **Session Isolation**: Each session independent (no cross-user data leakage)

---

## Migration Notes

**From**: No existing chatbot UI
**To**: ChatKit-based chat interface

**Data Migration**: None required (no existing data to migrate)

**Backward Compatibility**: N/A (new feature)

**Rollback Plan**: Remove chatkit_server.py and Chatbot component, no data cleanup needed
