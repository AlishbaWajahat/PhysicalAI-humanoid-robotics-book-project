# Data Model: RAG Chatbot Backend

**Feature**: 005-rag-chatbot-backend
**Date**: 2025-12-10
**Input**: Feature specification from `/specs/005-rag-chatbot-backend/spec.md`

## Overview

This document defines the data models for the RAG Chatbot Backend, focusing on the functional approach with clear data structures that flow between functions.

## Core Data Entities

### 1. BookContent
**Description**: Represents extracted content from MDX files in the docs/ directory

**Fields**:
- `id` (string): Unique identifier for the content chunk
- `source_path` (string): File path relative to docs/ directory
- `content` (string): The extracted text content
- `title` (string): Title or heading from the document
- `metadata` (dict): Additional document metadata (chapter, section, etc.)

**Validation**:
- `id` must be unique within the system
- `source_path` must be a valid path within docs/ directory
- `content` must not be empty

### 2. TextChunk
**Description**: Represents a segmented portion of book content suitable for embedding

**Fields**:
- `id` (string): Unique identifier for the chunk
- `content_id` (string): Reference to the original BookContent.id
- `text` (string): The chunked text content
- `chunk_index` (int): Position of this chunk within the original content
- `metadata` (dict): Chunk-specific metadata including source_path

**Validation**:
- `text` length must be within embedding model limits
- `chunk_index` must be non-negative
- Must maintain reference to original content via `content_id`

### 3. Embedding
**Description**: Represents the vector embedding of a text chunk

**Fields**:
- `chunk_id` (string): Reference to TextChunk.id
- `vector` (list[float]): The embedding vector from Cohere
- `model_name` (string): Name of the embedding model used
- `model_version` (string): Version of the embedding model

**Validation**:
- `vector` must be a valid numerical array
- `chunk_id` must reference an existing TextChunk

### 4. VectorRecord
**Description**: Represents data stored in Qdrant vector database

**Fields**:
- `id` (string): Unique identifier (same as chunk_id)
- `vector` (list[float]): The embedding vector
- `payload` (dict): Metadata including source_path, content, and additional context
- `collection_name` (string): Name of the Qdrant collection

**Validation**:
- `id` must be unique within the collection
- `vector` dimensions must match collection configuration
- `payload` must contain required metadata fields

### 5. UserQuery
**Description**: Represents a query from the user to the RAG system

**Fields**:
- `id` (string): Unique identifier for the query
- `text` (string): The user's question or query text
- `timestamp` (datetime): When the query was received
- `user_context` (dict): Optional user-specific context

**Validation**:
- `text` must not be empty
- `timestamp` must be in valid datetime format

### 6. RetrievedChunk
**Description**: Represents relevant chunks retrieved from Qdrant for a query

**Fields**:
- `chunk_id` (string): ID of the retrieved chunk
- `text` (string): The content of the chunk
- `relevance_score` (float): Score indicating relevance to the query
- `source_path` (string): Path to the original document
- `metadata` (dict): Additional metadata from the vector record

**Validation**:
- `relevance_score` must be between 0 and 1
- `chunk_id` must correspond to a valid vector record

### 7. AgentResponse
**Description**: Represents the final response generated by the agent

**Fields**:
- `query_id` (string): Reference to the original UserQuery.id
- `response_text` (string): The agent's response to the user
- `source_chunks` (list[string]): IDs of chunks used to generate the response
- `confidence` (float): Agent's confidence in the response
- `timestamp` (datetime): When the response was generated

**Validation**:
- `response_text` must not be empty
- `confidence` must be between 0 and 1
- `source_chunks` must reference valid RetrievedChunk records

## Data Flow

### Indexing Pipeline
1. **Extract**: `docs/` → `BookContent` → `TextChunk`
2. **Embed**: `TextChunk` → `Embedding` → `VectorRecord`
3. **Store**: `VectorRecord` → Qdrant database

### Query Pipeline
1. **Receive**: `UserQuery` from user
2. **Retrieve**: `UserQuery` → Qdrant → `RetrievedChunk[]` (top 5)
3. **Respond**: `RetrievedChunk[]` + `UserQuery` → `AgentResponse`

## Relationships

- `BookContent` → `TextChunk` (one-to-many)
- `TextChunk` → `Embedding` (one-to-one)
- `Embedding` → `VectorRecord` (one-to-one)
- `UserQuery` → `AgentResponse` (one-to-one)
- `UserQuery` → `RetrievedChunk[]` (one-to-many, top 5 results)

## Constraints

1. **Functional Immutability**: All data structures are treated as immutable in the functional approach
2. **Validation at Boundaries**: Data is validated when passed between functions
3. **Metadata Preservation**: Source information is preserved throughout the pipeline
4. **Unique Identification**: Each entity has a unique identifier for tracking and debugging